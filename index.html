<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MIX22 - Cupom Fiscal DinÃ¢mico</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{ background:#f0f0f0; }
.card-custom{
    border:none;
    border-radius:10px;
    box-shadow:0 5px 15px rgba(0,0,0,0.2);
}
.cupom{
    width:100%;
    max-width:600px;
    background:white;
    padding:15px;
    margin:auto;
    font-family:"Courier New", monospace;
    font-size:15px;
}
.cupom pre{
    margin:0;
    white-space: pre-wrap;
    line-height:1.3;
}
@media print {
    body *{ visibility:hidden; }
    #cupom, #cupom *{ visibility:visible; }
    #cupom{
        position:absolute;
        left:0;
        top:0;
        width:100%;
    }
}
</style>
</head>
<body>

<div class="container py-4">
<div class="row g-4">

<div class="col-md-6">
<div class="card card-custom p-4 bg-white">

<h5>Novo Pedido - MIX22</h5>

<div class="alert alert-secondary">
Pedido NÂº: <strong id="numeroPedido"></strong>
</div>

<input type="text" id="cliente" class="form-control mb-2" placeholder="Cliente">
<input type="text" id="contato" class="form-control mb-2" placeholder="Telefone do Cliente">

<select id="tipoEntrega" class="form-select mb-2" onchange="toggleEndereco()">
<option value="retirada">Retirada</option>
<option value="entrega">Entrega</option>
</select>

<div id="areaEndereco">
<input type="text" id="endereco" class="form-control mb-2" placeholder="Rua e NÃºmero">
<input type="text" id="complemento" class="form-control mb-2" placeholder="Complemento">
<input type="text" id="referencia" class="form-control mb-2" placeholder="Ponto de ReferÃªncia">
</div>

<div id="areaRetirada" style="display:none;">
<select id="lojaRetirada" class="form-select mb-2">
<option value="Lauro 01">Lauro 01</option>
<option value="Lauro02">Lauro02</option>
<option value="Itinga">Itinga</option>
<option value="Vida Nova Infantil">Vida Nova Infantil</option>
<option value="Vida Nova Adulto">Vida Nova Adulto</option>
</select>
</div>

<hr>

<div class="row g-2">
<div class="col-5">
<input type="text" id="produto" class="form-control" placeholder="Produto">
</div>
<div class="col-3">
<input type="number" id="quantidade" class="form-control" placeholder="Qtd">
</div>
<div class="col-4">
<input type="number" id="valor" class="form-control" placeholder="Valor">
</div>
</div>

<button class="btn btn-primary w-100 mt-2" onclick="adicionarItem()">Adicionar</button>

<ul class="list-group mt-3 mb-3" id="listaItens"></ul>

<input type="number" id="taxa" class="form-control mb-2" placeholder="Taxa" value="0">

<select id="pagamento" class="form-select mb-2">
<option>PIX</option>
<option>CartÃ£o</option>
<option>Dinheiro</option>
</select>

<button class="btn btn-success w-100 mb-2" onclick="finalizarPedido()">
Finalizar Pedido (Enviar Cliente)
</button>

<button class="btn btn-warning w-100 mb-2" onclick="enviarParaEntregador()">
Enviar para Entregador
</button>

<button class="btn btn-secondary w-100" onclick="imprimir()">Imprimir</button>

</div>
</div>

<div class="col-md-6">
<div class="cupom" id="cupom">
<pre id="resultado"></pre>
</div>
</div>

</div>
</div>

<script>
let itens = [];
let contadorPedido = localStorage.getItem("contadorPedido")
    ? parseInt(localStorage.getItem("contadorPedido"))
    : 1;

document.getElementById("numeroPedido").innerText = contadorPedido;

const entregador = { nome: "Fabricio", telefone: "557197270344" };

function toggleEndereco(){
    let tipo = document.getElementById("tipoEntrega").value;
    document.getElementById("areaEndereco").style.display = tipo==="entrega" ? "block":"none";
    document.getElementById("areaRetirada").style.display = tipo==="retirada" ? "block":"none";
}
toggleEndereco();

function adicionarItem(){
    let produto = document.getElementById("produto").value;
    let quantidade = parseFloat(document.getElementById("quantidade").value);
    let valor = parseFloat(document.getElementById("valor").value);

    if(!produto || quantidade<=0 || valor<=0){
        alert("Preencha corretamente os campos!");
        return;
    }

    itens.push({produto, quantidade, valor});
    atualizarLista();

    document.getElementById("produto").value="";
    document.getElementById("quantidade").value="";
    document.getElementById("valor").value="";
}

function atualizarLista(){
    let listaItens = document.getElementById("listaItens");
    listaItens.innerHTML="";
    itens.forEach(item=>{
        let total=item.quantidade*item.valor;
        listaItens.innerHTML+=
        `<li class="list-group-item d-flex justify-content-between">
        ${item.quantidade}x ${item.produto}
        <span>${total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</span>
        </li>`;
    });
}

function gerarCupom(){
    let cliente = document.getElementById("cliente").value;
    let contato = document.getElementById("contato").value;
    let tipo = document.getElementById("tipoEntrega").value;
    let taxa = parseFloat(document.getElementById("taxa").value) || 0;
    let pagamento = document.getElementById("pagamento").value;

    let subtotal=0, itensTexto="";
    itens.forEach(item=>{
        let total=item.quantidade*item.valor;
        subtotal+=total;
        itensTexto+=`${item.quantidade}x ${item.produto} - ${total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}\n`;
    });

    let totalFinal=subtotal+taxa;
    let agora = new Date().toLocaleString("pt-BR");

    let enderecoTexto="", mapaLink="";
    if(tipo==="entrega"){
        let endereco = document.getElementById("endereco").value;
        let complemento = document.getElementById("complemento").value;

        enderecoTexto = `Entrega:\n${endereco}\n${complemento}\n`;

        // ðŸ”¥ AGORA USA APENAS ENDEREÃ‡O + COMPLEMENTO
        mapaLink = "https://www.google.com/maps/search/?api=1&query=" +
        encodeURIComponent(endereco + " " + complemento);
    } else {
        let loja = document.getElementById("lojaRetirada").value;
        enderecoTexto=`Retirada na loja: ${loja}\n`;
    }

    let cupom = `
*************** MIX22 ***************
PEDIDO NÂº ${contadorPedido}
${agora}
--------------------------------
Cliente: ${cliente}
Contato: ${contato}
--------------------------------
${enderecoTexto}
--------------------------------
ITENS:
${itensTexto}
--------------------------------
Subtotal: ${subtotal.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
Taxa: ${taxa.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
TOTAL: ${totalFinal.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
Pagamento: ${pagamento}
--------------------------------
OBRIGADO PELA PREFERÃŠNCIA!
`;

    document.getElementById("resultado").textContent=cupom;

    return {cupom, mapaLink, tipo};
}

function enviarWhatsApp(numero, mensagem){
    numero = numero.replace(/\D/g,'');
    if(!numero.startsWith("55")) numero="55"+numero;
    window.open("https://wa.me/"+numero+"?text="+encodeURIComponent(mensagem),"_blank");
}

function finalizarPedido(){
    let dados = gerarCupom();
    let mensagem = document.getElementById("resultado").textContent;

    if(dados.tipo==="entrega"){
        mensagem += "\n\nðŸ“ LOCALIZAÃ‡ÃƒO:\n"+dados.mapaLink;
    }

    let telefoneCliente = document.getElementById("contato").value;
    if(telefoneCliente) enviarWhatsApp(telefoneCliente, mensagem);

    contadorPedido++;
    localStorage.setItem("contadorPedido", contadorPedido);
    document.getElementById("numeroPedido").innerText = contadorPedido;

    itens=[];
    atualizarLista();
}

function enviarParaEntregador(){
    let dados = gerarCupom();
    let mensagem = document.getElementById("resultado").textContent;

    if(dados.tipo==="entrega"){
        let endereco = document.getElementById("endereco").value;
        if(!endereco){
            alert("Digite o endereÃ§o antes de enviar!");
            return;
        }
        mensagem += "\n\nðŸ“ LOCALIZAÃ‡ÃƒO NO MAPA:\n"+dados.mapaLink;
    }

    enviarWhatsApp(entregador.telefone, mensagem);
}

function imprimir(){
    gerarCupom();
    setTimeout(()=>{ window.print(); },500);
}
</script>

</body>
</html>

