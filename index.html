<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Profissional de Pedidos</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>

body{
    background: linear-gradient(135deg,#1f2937,#111827);
}

.card-custom{
    border:none;
    border-radius:15px;
    box-shadow:0 10px 30px rgba(0,0,0,0.3);
}

.nota{
    background:white;
    padding:25px;
    border-radius:15px;
    min-height:500px;
    white-space:pre-line;
}

/* IMPRESSÃO PROFISSIONAL */
@media print {

    body{
        background:white !important;
    }

    body *{
        visibility:hidden;
    }

    #nota, #nota *{
        visibility:visible;
    }

    #nota{
        position:absolute;
        left:0;
        top:0;
        width:100%;
        box-shadow:none;
        border-radius:0;
    }
}

</style>
</head>
<body>

<div class="container py-5">
<div class="row g-4">

<!-- FORMULÁRIO -->
<div class="col-lg-6">
<div class="card card-custom p-4 bg-white">

<h4 class="mb-3">Novo Pedido</h4>

<div class="alert alert-secondary">
Pedido Nº: <strong id="numeroPedido"></strong>
</div>

<input type="text" id="cliente" class="form-control mb-2" placeholder="Nome do Cliente">
<input type="text" id="contato" class="form-control mb-3" placeholder="Telefone">

<select id="tipoEntrega" class="form-select mb-2" onchange="verificarEntrega()">
<option value="">Tipo de Atendimento</option>
<option value="retirada">Retirada no Local</option>
<option value="entrega">Entrega</option>
</select>

<select id="lojas" class="form-select mb-2 d-none">
<option>Loja 01</option>
<option>Loja 02</option>
<option>Loja 03</option>
<option>Loja 04</option>
</select>

<div id="enderecoEntrega" class="d-none">
<input type="text" id="rua" class="form-control mb-2" placeholder="Rua">
<input type="text" id="numero" class="form-control mb-2" placeholder="Número">
<input type="text" id="bairro" class="form-control mb-2" placeholder="Bairro">
<input type="text" id="cidade" class="form-control mb-3" placeholder="Cidade">
</div>

<hr>

<h6>Adicionar Item</h6>

<div class="row g-2">
<div class="col-5">
<input type="text" id="produto" class="form-control" placeholder="Produto">
</div>
<div class="col-3">
<input type="number" id="quantidade" class="form-control" placeholder="Qtd">
</div>
<div class="col-4">
<input type="number" id="valor" class="form-control" placeholder="Valor">
</div>
</div>

<button class="btn btn-primary w-100 mt-2" onclick="adicionarItem()">Adicionar</button>

<ul class="list-group mt-3 mb-3" id="listaItens"></ul>

<input type="number" id="taxa" class="form-control mb-2" placeholder="Taxa Entrega" value="0">

<select id="pagamento" class="form-select mb-2" onchange="verificarPagamento()">
<option>PIX</option>
<option>Cartão</option>
<option>Dinheiro</option>
</select>

<input type="number" id="trocoPara" class="form-control mb-3 d-none" placeholder="Troco para">

<div class="d-grid gap-2">
<button class="btn btn-success" onclick="gerarNota()">Gerar Nota</button>
<button class="btn btn-warning" onclick="enviarParaEntregador()">Enviar para Entregador</button>
<button class="btn btn-secondary" onclick="imprimirNota()">Imprimir</button>
<button class="btn btn-danger" onclick="gerarPDF()">Gerar PDF</button>
</div>

</div>
</div>

<!-- NOTA -->
<div class="col-lg-6">
<div class="nota" id="nota">
<pre id="resultado"></pre>
</div>
</div>

</div>
</div>

<script>

let itens = [];

/* CONTADOR AUTOMÁTICO */
let contadorPedido = localStorage.getItem("contadorPedido")
    ? parseInt(localStorage.getItem("contadorPedido"))
    : 1;

document.getElementById("numeroPedido").innerText = contadorPedido;

/* ENTREGADOR */
const entregador = {
    nome: "Fabricio",
    telefone: "557197270344"
};

function verificarEntrega(){
    let tipo = document.getElementById("tipoEntrega").value;
    document.getElementById("lojas").classList.toggle("d-none", tipo !== "retirada");
    document.getElementById("enderecoEntrega").classList.toggle("d-none", tipo !== "entrega");
}

function verificarPagamento(){
    document.getElementById("trocoPara").classList.toggle("d-none",
        document.getElementById("pagamento").value !== "Dinheiro");
}

function adicionarItem(){

    let produto = document.getElementById("produto").value;
    let quantidade = parseFloat(document.getElementById("quantidade").value);
    let valor = parseFloat(document.getElementById("valor").value);

    if(!produto || !quantidade || !valor){
        alert("Preencha todos os campos do item!");
        return;
    }

    itens.push({produto, quantidade, valor});
    atualizarLista();

    document.getElementById("produto").value="";
    document.getElementById("quantidade").value="";
    document.getElementById("valor").value="";
}

function atualizarLista(){

    let lista = document.getElementById("listaItens");
    lista.innerHTML="";

    itens.forEach((item,index)=>{
        let total = item.quantidade * item.valor;

        lista.innerHTML += `
        <li class="list-group-item d-flex justify-content-between">
            ${item.quantidade}x ${item.produto}
            <span>
                R$ ${total.toFixed(2)}
                <button class="btn btn-sm btn-danger ms-2" onclick="removerItem(${index})">X</button>
            </span>
        </li>`;
    });
}

function removerItem(index){
    itens.splice(index,1);
    atualizarLista();
}

function gerarNota(){

    let cliente = document.getElementById("cliente").value;
    let contato = document.getElementById("contato").value;
    let taxa = parseFloat(document.getElementById("taxa").value) || 0;
    let pagamento = document.getElementById("pagamento").value;
    let trocoPara = parseFloat(document.getElementById("trocoPara").value) || 0;

    let subtotal=0;
    let listaTexto="";

    itens.forEach(item=>{
        let total = item.quantidade * item.valor;
        subtotal+=total;
        listaTexto += `${item.quantidade}x ${item.produto} - R$ ${total.toFixed(2)}\n`;
    });

    let totalFinal = subtotal + taxa;
    let troco = pagamento==="Dinheiro" ? trocoPara-totalFinal : 0;

    let enderecoTexto="";
    let mapaLink="";

    if(document.getElementById("tipoEntrega").value==="retirada"){
        enderecoTexto="Retirada em: "+document.getElementById("lojas").value;
    } else {
        let rua=document.getElementById("rua").value;
        let numero=document.getElementById("numero").value;
        let bairro=document.getElementById("bairro").value;
        let cidade=document.getElementById("cidade").value;

        enderecoTexto=`Entrega: ${rua}, ${numero} - ${bairro} - ${cidade}`;
        mapaLink=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(rua+" "+numero+" "+bairro+" "+cidade)}`;
    }

    let nota = `
PEDIDO Nº ${contadorPedido}

Cliente: ${cliente}
Contato: ${contato}
${enderecoTexto}

ITENS:
${listaTexto}

Subtotal: R$ ${subtotal.toFixed(2)}
Taxa: R$ ${taxa.toFixed(2)}
TOTAL: R$ ${totalFinal.toFixed(2)}
Pagamento: ${pagamento}
`;

    if(pagamento==="Dinheiro"){
        nota+=`Troco: R$ ${troco.toFixed(2)}\n`;
    }

    if(mapaLink){
        nota+=`\nMapa: ${mapaLink}`;
    }

    document.getElementById("resultado").textContent=nota;

    return nota;
}

/* WHATSAPP */
function enviarParaEntregador(){
    let nota = gerarNota();
    let url = `https://wa.me/${entregador.telefone}?text=${encodeURIComponent(nota)}`;
    window.open(url,"_blank");
}

/* IMPRESSÃO CORRETA */
function imprimirNota(){
    gerarNota();
    setTimeout(()=>{
        window.print();
    },300);
}

/* PDF */
async function gerarPDF(){
    const { jsPDF } = window.jspdf;
    let doc = new jsPDF();
    doc.text(document.getElementById("resultado").textContent,10,10);
    doc.save("pedido_"+contadorPedido+".pdf");
}

/* AUMENTA O NÚMERO APÓS GERAR */
document.querySelector(".btn-success").addEventListener("click",()=>{
    localStorage.setItem("contadorPedido", contadorPedido + 1);
});

</script>

</body>
</html>
