<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MIX22 - Cupom Fiscal 80mm</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
    background:#f0f0f0;
}

.card-custom{
    border:none;
    border-radius:10px;
    box-shadow:0 5px 15px rgba(0,0,0,0.2);
}

.cupom{
    width:480px; /* 80mm */
    background:white;
    padding:15px;
    margin:auto;
    font-family:"Courier New", monospace;
    font-size:13px;
    color:#000;
    text-align:left;
}

.cupom pre{
    margin:0;
    white-space: pre-wrap;
    word-wrap: break-word;
    line-height:1.2;
}

@media print {
    body {
        margin:0;
        padding:0;
    }
    body *{
        visibility:hidden;
    }

    #cupom, #cupom *{
        visibility:visible;
    }

    #cupom{
        position:absolute;
        left:0;
        top:0;
        width:80mm;
        text-align:left;
        height:auto;
    }
}
</style>
</head>
<body>

<div class="container py-4">
<div class="row g-4">

<!-- FORM -->
<div class="col-md-6">
<div class="card card-custom p-4 bg-white">

<h5>Novo Pedido - MIX22</h5>

<div class="alert alert-secondary">
Pedido Nº: <strong id="numeroPedido"></strong>
</div>

<input type="text" id="cliente" class="form-control mb-2" placeholder="Cliente">
<input type="text" id="contato" class="form-control mb-2" placeholder="Telefone">

<select id="tipoEntrega" class="form-select mb-2" onchange="toggleEndereco()">
<option value="retirada">Retirada</option>
<option value="entrega">Entrega</option>
</select>

<div id="areaEndereco">
<input type="text" id="endereco" class="form-control mb-2" placeholder="Rua e Número">
<input type="text" id="complemento" class="form-control mb-2" placeholder="Complemento">
<input type="text" id="referencia" class="form-control mb-2" placeholder="Ponto de Referência">
</div>

<hr>

<div class="row g-2">
<div class="col-5">
<input type="text" id="produto" class="form-control" placeholder="Produto">
</div>
<div class="col-3">
<input type="number" id="quantidade" class="form-control" placeholder="Qtd">
</div>
<div class="col-4">
<input type="number" id="valor" class="form-control" placeholder="Valor">
</div>
</div>

<button class="btn btn-primary w-100 mt-2" onclick="adicionarItem()">Adicionar</button>

<ul class="list-group mt-3 mb-3" id="listaItens"></ul>

<input type="number" id="taxa" class="form-control mb-2" placeholder="Taxa" value="0">

<select id="pagamento" class="form-select mb-2">
<option>PIX</option>
<option>Cartão</option>
<option>Dinheiro</option>
</select>

<button class="btn btn-success w-100 mb-2" onclick="gerarCupom()">Gerar Cupom</button>
<button class="btn btn-warning w-100 mb-2" onclick="enviarParaEntregador()">Enviar para Entregador</button>
<button class="btn btn-secondary w-100" onclick="imprimir()">Imprimir</button>

</div>
</div>

<!-- CUPOM -->
<div class="col-md-6">
<div class="cupom" id="cupom">
<pre id="resultado"></pre>
</div>
</div>

</div>
</div>

<script>

let itens = [];

let contadorPedido = localStorage.getItem("contadorPedido")
    ? parseInt(localStorage.getItem("contadorPedido"))
    : 1;

document.getElementById("numeroPedido").innerText = contadorPedido;

/* ENTREGADOR */
const entregador = {
    nome: "Fabricio",
    telefone: "557197270344"
};

function toggleEndereco(){
    let tipo = document.getElementById("tipoEntrega").value;
    document.getElementById("areaEndereco").style.display =
        tipo === "entrega" ? "block" : "none";
}
toggleEndereco();

function adicionarItem(){

    let produto = document.getElementById("produto").value;
    let quantidade = parseFloat(document.getElementById("quantidade").value);
    let valor = parseFloat(document.getElementById("valor").value);

    if(!produto || !quantidade || !valor){
        alert("Preencha todos os campos!");
        return;
    }

    itens.push({produto, quantidade, valor});
    atualizarLista();

    document.getElementById("produto").value="";
    document.getElementById("quantidade").value="";
    document.getElementById("valor").value="";
}

function atualizarLista(){

    let listaItens = document.getElementById("listaItens");
    listaItens.innerHTML="";

    itens.forEach(item=>{
        let total=item.quantidade*item.valor;

        listaItens.innerHTML+=`
        <li class="list-group-item d-flex justify-content-between">
        ${item.quantidade}x ${item.produto}
        <span>R$ ${total.toFixed(2)}</span>
        </li>`;
    });
}

function gerarCupom(){

    let cliente = document.getElementById("cliente").value;
    let contato = document.getElementById("contato").value;
    let tipo = document.getElementById("tipoEntrega").value;
    let endereco = document.getElementById("endereco").value;
    let complemento = document.getElementById("complemento").value;
    let referencia = document.getElementById("referencia").value;
    let taxa = parseFloat(document.getElementById("taxa").value) || 0;
    let pagamento = document.getElementById("pagamento").value;

    let subtotal=0;
    let itensTexto="";

    itens.forEach(item=>{
        let total=item.quantidade*item.valor;
        subtotal+=total;

        // garante alinhamento para ~48 chars
        let nomeProd = item.produto.length>30 ? item.produto.slice(0,30) : item.produto;
        itensTexto+=`${item.quantidade}x ${nomeProd.padEnd(30,' ')}R$ ${total.toFixed(2)}\n`;
    });

    let totalFinal=subtotal+taxa;
    let agora = new Date().toLocaleString("pt-BR");

    let enderecoTexto="";
    let mapaLink="";

    if(tipo==="entrega"){
        enderecoTexto = `Entrega:
${endereco}
${complemento ? "Comp: "+complemento : ""}
${referencia ? "Ref: "+referencia : ""}
`;

        mapaLink = "https://www.google.com/maps/search/?api=1&query=" +
            encodeURIComponent(endereco + " " + complemento + " " + referencia);

    } else {
        enderecoTexto="Retirada no Local\n";
    }

    // ASCII Logo centralizado (~48 caracteres por linha)
    let logoAscii = `
************************************************
*                                              *
*                    MIX22                     *
*                                              *
************************************************
`;

    let cupom = `
${logoAscii}
PEDIDO Nº ${contadorPedido}
${agora}
--------------------------------
Cliente: ${cliente}
Contato: ${contato}
--------------------------------
${enderecoTexto}
--------------------------------
ITENS:
${itensTexto}
--------------------------------
Subtotal: R$ ${subtotal.toFixed(2)}
Taxa:     R$ ${taxa.toFixed(2)}
TOTAL:    R$ ${totalFinal.toFixed(2)}
Pagamento: ${pagamento}
--------------------------------
OBRIGADO PELA PREFERÊNCIA!
`;

    document.getElementById("resultado").textContent=cupom;

    localStorage.setItem("contadorPedido", contadorPedido+1);

    return {cupom, mapaLink};
}

function enviarParaEntregador(){

    let dados = gerarCupom();

    let mensagem = document.getElementById("resultado").textContent;

    if(dados.mapaLink){
        mensagem += "\nMapa: " + dados.mapaLink;
    }

    let url = "https://wa.me/" + entregador.telefone + "?text=" + encodeURIComponent(mensagem);

    window.open(url, "_blank");
}

function imprimir(){
    gerarCupom();
    setTimeout(()=>{ window.print(); },500); // espera o DOM atualizar
}

</script>

</body>
</html>
